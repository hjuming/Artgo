<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artgo Cafe 雅鴿書院－日式料理 極上總督盛宴</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f3f1;
            color: #3e2723;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .hero-image {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
        }
        .hero-block {
            color: white;
            text-align: center;
            padding: 2.5rem 1rem;
        }
        @media (min-width: 768px) {
            .hero-block {
                padding: 3.5rem 1.5rem;
            }
        }
        .category-image, .alacarte-image {
             width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .final-page-image {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 8px;
        }
        .section-title {
            color: #3e2723;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 2px solid #a1887f;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        label.option-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        label.option-label:hover, input:checked + label.option-label {
            background-color: #efebe9;
            border-color: #a1887f;
        }
        input[type="radio"], input[type="checkbox"] {
            display: none;
        }
        .price {
            font-weight: 500;
            color: #5d4037;
        }
        .btn {
            background-color: #8d6e63;
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            text-align: center;
        }
        .btn:hover { background-color: #6d4c41; }
        .btn-secondary { background-color: #a1887f; }
        .btn-secondary:hover { background-color: #8d6e63; }
        .btn-large { padding: 1.1rem 2.2rem; font-size: 1.25rem; }
        .contact-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #f5f5f5;
            color: #5d4037;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            text-decoration: none;
            transition: all 0.3s;
            margin: 0 0.25rem;
            font-size: 1.25rem;
        }
        .contact-btn:hover { background-color: #e0e0e0; }
        .set-choice-btn {
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 12px;
            color: white;
        }
        .set-choice-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: #8d6e63;
        }
        .fixed-item {
            background-color: #fafafa;
            padding: 0.75rem;
            border-radius: 6px;
            color: #555;
        }
        .subtotal-display {
            background-color: #efebe9;
            color: #3e2723;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-align: right;
        }
        .notice-text {
            font-size: 0.8rem;
            color: #757575;
            text-align: center;
            line-height: 1.7;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-2xl mx-auto">
        <div class="card">
            
            <div id="main-content">
                <!-- Start View -->
                <div id="start-view">
                    <div class="p-6 md:p-8">
                        <div class="text-center">
                            <h1 class="text-2xl md:text-3xl font-bold mb-2">Artgo Cafe 雅鴿書院</h1>
                            <h2 class="text-xl md:text-2xl font-semibold text-gray-600 mb-6">日式料理 極上總督盛宴</h2>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 my-8 items-center">
                            <img src="https://i.urusai.cc/5Gxbe.jpg" alt="孫立人將軍官邸" class="w-full h-48 object-cover rounded-lg">
                            <div>
                                <h3 class="text-lg font-bold mb-2">孫立人將軍官邸</h3>
                                <p class="text-sm text-gray-600">雅鴿書院位於將軍官邸-和館區域，此區曾作為研究中心，有日治時代最早的圖書館之稱。在百年古蹟裡結合日式美食與文化，交融出全新風格的饗宴體驗。</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 my-8 items-center">
                             <div>
                                <h3 class="text-lg font-bold mb-2">關於雅鴿書院</h3>
                                <p class="text-sm text-gray-600">雅鴿文創成立於2017年，本著創新的思維，希望運用台灣豐富多元的人文底蘊，融合科技與商業行銷，推動文創活動發展。</p>
                            </div>
                            <img src="https://i.urusai.cc/NOb6J.jpg" alt="雅鴿書院" class="w-full h-48 object-cover rounded-lg">
                        </div>
                        
                        <div class="text-center my-6">
                            <div class="flex justify-center">
                                <a href="https://maps.app.goo.gl/Wm5D2P7WYY4Fa92L6" target="_blank" class="contact-btn"><i class="fa-solid fa-map-location-dot"></i></a>
                                <a href="http://www.artgo.com.tw" target="_blank" class="contact-btn"><i class="fa-solid fa-globe"></i></a>
                            </div>
                            <a href="tel:0223962685" class="block mt-4 text-lg text-gray-700 hover:text-black no-underline">
                                <i class="fa-solid fa-phone mr-2"></i>02-2396-2685
                            </a>
                        </div>

                        <div class="max-w-xs mx-auto my-8">
                            <label for="diner-count" class="block text-lg font-medium text-center mb-2">請選擇用餐人數</label>
                            <select id="diner-count" name="diner-count" class="w-full text-center text-xl p-3 border-2 border-gray-300 rounded-lg focus:ring-amber-800 focus:border-amber-800 bg-white appearance-none">
                                <option value="1">1 人</option>
                                <option value="2" selected>2 人</option>
                                <option value="3">3 人</option>
                                <option value="4">4 人</option>
                                <option value="5">5 人</option>
                                <option value="6">6 人</option>
                            </select>
                        </div>
                        
                        <div class="text-center">
                            <button id="start-order-btn" class="btn btn-large">開始點餐</button>
                        </div>

                        <div class="mt-8 notice-text">
                            <p>本店另收10%服務費</p>
                            <p>下午茶時段低消為一杯飲品，午晚餐時段為一個套餐</p>
                            <p>不得攜帶外食入內食用，違者酌收500元清潔費</p>
                            <p>餐點恕不提供外帶，煩請見諒</p>
                            <p>Wifi 名稱：孫立人官邸WIFI \ 密碼：12345678</p>
                        </div>
                    </div>
                </div>

                <!-- Set Selection View -->
                <div id="set-selection-view" class="hidden">
                     <img src="https://i.urusai.cc/X7J3U.jpg" alt="極上總督盛宴" class="hero-image">
                     <div class="p-6 md:p-8">
                        <h2 id="person-title" class="text-xl font-bold text-center mb-6"></h2>
                        <div class="grid grid-cols-2 gap-4 md:gap-6">
                            <div class="set-choice-btn bg-amber-800" data-set-type="single">
                                <div class="text-center">
                                    <h3 class="text-xl md:text-2xl font-semibold">單人日式套餐</h3>
                                </div>
                            </div>
                            <div class="set-choice-btn bg-stone-700" data-set-type="double">
                                <div class="text-center">
                                    <h3 class="text-xl md:text-2xl font-semibold">雙人總督套餐</h3>
                                </div>
                            </div>
                        </div>
                         <div class="mt-8 text-center">
                            <button id="back-to-home-btn1" class="btn btn-secondary">回首頁修改人數</button>
                        </div>
                    </div>
                </div>

                <!-- Ordering View -->
                <div id="ordering-view" class="hidden">
                     <div id="ordering-hero-image-container"></div>
                     <div class="p-6 md:p-8">
                         <h2 id="ordering-person-title" class="text-xl font-bold text-center mb-6"></h2>
                         <form id="order-form" class="space-y-8"></form>
                     </div>
                </div>

                <!-- Summary View -->
                <div id="summary-view" class="hidden">
                    <img src="https://i.urusai.cc/X7J3U.jpg" alt="極上總督盛宴" class="hero-image">
                    <div class="p-6 md:p-8">
                        <h2 class="section-title">訂單總覽</h2>
                        <div id="order-details" class="space-y-6"></div>
                        
                        <div id="alacarte-section" class="mt-8"></div>
                        
                        <div id="order-total" class="mt-8 pt-4 border-t-2 text-right space-y-2 font-semibold"></div>
                        <div class="mt-8 flex flex-wrap justify-between items-center gap-4">
                           <div class="flex items-center space-x-2">
                                <label for="summary-diner-count">人數:</label>
                                <select id="summary-diner-count" name="summary-diner-count" class="w-24 text-center p-2 border-2 border-gray-300 rounded-lg bg-white appearance-none">
                                    <option value="1">1 人</option>
                                    <option value="2" selected>2 人</option>
                                    <option value="3">3 人</option>
                                    <option value="4">4 人</option>
                                    <option value="5">5 人</option>
                                    <option value="6">6 人</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                               <button id="add-more-diners-btn" class="btn btn-secondary">繼續點餐</button>
                               <button id="submit-final-order-btn" class="btn">確認送出訂單</button>
                           </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Final Order View (Screenshot page) -->
            <div id="final-order-view" class="hidden">
                 <img src="https://i.urusai.cc/X7J3U.jpg" alt="極上總督盛宴" class="hero-image">
                 <div class="p-6 md:p-8">
                    <h2 class="section-title text-center">您的訂單已確認</h2>
                    <div id="order-number-display" class="text-center text-gray-600 mb-6"></div>
                    <div id="final-order-details" class="space-y-6"></div>
                    <div id="final-order-total" class="mt-8 pt-4 border-t-2 text-right space-y-2 font-semibold"></div>
                    
                    <div class="mt-8 text-center">
                        <img src="https://i.urusai.cc/NOb6J.jpg" alt="雅鴿書院" class="final-page-image mb-6">
                         <div class="text-center my-6">
                            <div class="flex justify-center">
                                <a href="https://maps.app.goo.gl/Wm5D2P7WYY4Fa92L6" target="_blank" class="contact-btn"><i class="fa-solid fa-map-location-dot"></i></a>
                                <a href="http://www.artgo.com.tw" target="_blank" class="contact-btn"><i class="fa-solid fa-globe"></i></a>
                            </div>
                            <a href="tel:0223962685" class="block mt-4 text-lg text-gray-700 hover:text-black no-underline">
                                <i class="fa-solid fa-phone mr-2"></i>02-2396-2685
                            </a>
                        </div>
                        <button id="restart-order-btn" class="btn btn-large">回到首頁，重新點餐</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const menuData = {
            singleSet: {
                name: '單人日式套餐',
                fixedItems: ['開胃小菜', '土瓶蒸', '甜點'],
                options: {
                    appetizer: { title: '前菜 (2選1)', items: [{ name: '刺身', price: 0 }, { name: '鮑魚沙拉', price: 0 }] },
                    mainCourse: {
                        title: '主餐 (選1)',
                        categories: {
                            '烤物': { image: 'https://i.urusai.cc/CfRgb.jpg', items: [{ name: "味噌松阪豬", price: 950 }, { name: "烤魚下巴", price: 950 }, { name: "烤一夜干(一尾)", price: 1050 }, { name: "烤鮭魚頭", price: 1380 }] },
                            '握壽司': { image: 'https://i.urusai.cc/wtFQv.jpg', items: [{ name: "綜合海鮮握壽司(七貫)", price: 950 }, { name: "鮭魚握壽司(七貫)", price: 950 }, { name: "炙燒鮭魚腹壽司(七貫)", price: 970 }] },
                            '海鮮丼': { image: 'https://i.urusai.cc/bKCC3.jpg', items: [{ name: "極上海鮮丼", price: 950 }, { name: "綜合炙燒海鮮丼", price: 970 }] },
                            '烤物丼飯': { image: 'https://i.urusai.cc/q3vTn.jpg', items: [{ name: "帶骨牛小排丼", price: 950 }, { name: "醬烤鰻魚丼", price: 990 }] }
                        }
                    },
                    sideDish: { title: '附餐 (3選1)', items: [{ name: "炙燒明太子山藥", price: 0 }, { name: "生食級明太子干貝", price: 120 }, { name: "烤一夜干(半隻)", price: 150 }] },
                    drink: { title: '飲料 (2選1)', items: [{ name: '美式咖啡', price: 0 }, { name: '紅茶', price: 0 }] }
                }
            },
            doubleSet: {
                name: '雙人總督套餐',
                basePrice: 2780,
                fixedItems: ['開胃小菜x2', '前菜刺身', '烤一夜干', '總督握壽司', '烤鰻魚飯x2', '土瓶蒸x2', '甜點x2'],
                options: {
                    mainChoice: { title: '主餐選擇 (2選1)', items: [{ name: '味噌松阪豬', price: 0 }, { name: '日式帶骨牛小排', price: 0 }] },
                    drinks: { title: '飲料 (2選2)', items: ['美式咖啡', '紅茶'] }
                }
            },
            aLaCarte: {
                 '單點烤物': { image: 'https://i.urusai.cc/XDAqa.jpg', items: [{ name: '明太子飯糰(一顆)', price: 100 }, { name: '生食級明太子干貝(一顆)', price: 150 }, { name: '烤一夜干(一尾)', price: 480 }, { name: '烤魚下巴(一個)', price: 500 }, { name: '烤鮭魚頭(一個)', price: 750 }] },
                 '單點握壽司': { image: 'https://i.urusai.cc/3CAfq.jpg', items: [{ name: '花壽司(一貫)', price: 50 }, { name: '生鮭魚握壽司(七貫)', price: 720 }, { name: '炙燒鮭魚腹壽司(七貫)', price: 720 }, { name: '總督握壽司(十貫)', price: 800 }] }
            }
        };

        // --- STATE MANAGEMENT ---
        let totalDiners = 2;
        let dinersOrdered = 0;
        let allOrders = [];
        let editingOrderId = null;

        // --- DOM ELEMENTS ---
        const allViews = ['start-view', 'set-selection-view', 'ordering-view', 'summary-view', 'final-order-view'];
        const dinerCountInput = document.getElementById('diner-count');
        const summaryDinerCountInput = document.getElementById('summary-diner-count');
        const orderForm = document.getElementById('order-form');

        // --- UTILITY FUNCTIONS ---
        const formatPrice = (price) => price.toLocaleString('en-US');

        function showView(viewId) {
            window.scrollTo(0, 0);
            allViews.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById('main-content').classList.toggle('hidden', viewId === 'final-order-view');
        }

        const getFormData = form => Object.fromEntries(new FormData(form).entries());

        // --- FORM BUILDER & RENDERING ---
        function createRadioGroup(name, title, items) {
            const itemsHTML = items.map((item, index) => `
                <div>
                    <input type="radio" id="${name}-${index}" name="${name}" value="${item.name}" data-price="${item.price}" required ${index === 0 ? 'checked' : ''}>
                    <label for="${name}-${index}" class="option-label">
                        <span>${item.name}</span>
                        <span class="price">${item.price > 0 ? `+NT$ ${formatPrice(item.price)}` : '+NT$ 0'}</span>
                    </label>
                </div>`).join('');
            return `<div><h3 class="section-title text-base">${title}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${itemsHTML}</div></div>`;
        }
        
        function createSelectGroup(name, title, items) {
            const optionsHTML = items.map(item => `<option value="${item}">${item}</option>`).join('');
            return `<div class="md:col-span-1"><label for="${name}" class="block text-sm font-medium text-gray-700 mb-1">${title}</label><select id="${name}" name="${name}" class="w-full p-2 border border-gray-300 rounded-md">${optionsHTML}</select></div>`;
        }

        function createFixedItemsSection(title, items) {
            const itemsHTML = items.map(item => `<li class="fixed-item">${item}</li>`).join('');
            return `<div><h3 class="section-title text-base">${title}</h3><ul class="grid grid-cols-2 md:grid-cols-3 gap-2">${itemsHTML}</ul></div>`;
        }
        
        function populateSingleSetForm(orderData = null) {
            const { appetizer, mainCourse, sideDish, drink } = menuData.singleSet.options;
            orderForm.dataset.formType = 'single';
            
            let mainCourseHTML = `<h3 class="section-title text-base">${mainCourse.title}</h3>`;
            for (const [category, data] of Object.entries(mainCourse.categories)) {
                mainCourseHTML += `
                    <div>
                        <img src="${data.image}" alt="${category}" class="category-image">
                        <h4 class="font-semibold text-gray-700 mb-2 text-center">${category}主餐</h4>
                        ${data.items.map((item, index) => `
                            <div class="ml-4 mb-2">
                                <input type="radio" id="mainCourse-${category}-${index}" name="mainCourse" value="${item.name}" data-price="${item.price}" required>
                                <label for="mainCourse-${category}-${index}" class="option-label">
                                    <span>${item.name}</span>
                                    <span class="price">NT$ ${formatPrice(item.price)}</span>
                                </label>
                            </div>`).join('')}
                    </div>`;
            }

            orderForm.innerHTML = `
                ${createFixedItemsSection('固定菜色', menuData.singleSet.fixedItems.slice(0, 1))}
                ${createRadioGroup('appetizer', appetizer.title, appetizer.items)}
                <div>${mainCourseHTML}</div>
                ${createRadioGroup('sideDish', sideDish.title, sideDish.items)}
                ${createFixedItemsSection('', menuData.singleSet.fixedItems.slice(1))}
                ${createRadioGroup('drink', drink.title, drink.items)}
                <p class="notice-text text-sm mt-4">附餐飲品價值200元,可補差額更換/圖片僅供參考,以實際提供為主</p>
                <div class="subtotal-display" id="live-subtotal"></div>
                <div class="flex justify-between items-center pt-4">
                    <button type="button" class="btn btn-secondary back-to-select">返回選擇套餐</button>
                    <button type="submit" class="btn">確定此位顧客餐點</button>
                </div>`;

            if (orderData) {
                Object.entries(orderData.selections).forEach(([key, value]) => {
                    const input = orderForm.querySelector(`[name="${key}"][value="${value}"]`);
                    if (input) input.checked = true;
                });
            } else {
                orderForm.querySelector('[name="mainCourse"]').checked = true;
            }
            orderForm.querySelectorAll('input[type="radio"]').forEach(radio => radio.addEventListener('change', updateLiveSubtotal));
            updateLiveSubtotal();
        }

        function populateDoubleSetForm(orderData = null) {
            const { mainChoice, drinks } = menuData.doubleSet.options;
            orderForm.dataset.formType = 'double';
            orderForm.innerHTML = `
                ${createFixedItemsSection('套餐內容', menuData.doubleSet.fixedItems)}
                ${createRadioGroup('mainChoice', mainChoice.title, mainChoice.items)}
                <div>
                    <h3 class="section-title text-base">${drinks.title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${createSelectGroup('drink1', '第一杯', drinks.items)}
                        ${createSelectGroup('drink2', '第二杯', drinks.items)}
                    </div>
                </div>
                 <p class="notice-text text-sm mt-4">附餐飲品價值200元,可補差額更換/圖片僅供參考,以實際提供為主</p>
                <div class="subtotal-display" id="live-subtotal"></div>
                <div class="flex justify-between items-center pt-4">
                  <button type="button" class="btn btn-secondary back-to-select">返回選擇套餐</button>
                  <button type="submit" class="btn">確定這兩位顧客餐點</button>
                </div>`;
            if (orderData) {
                const { mainChoice, drink1, drink2 } = orderData.selections;
                orderForm.querySelector(`[name="mainChoice"][value="${mainChoice}"]`).checked = true;
                orderForm.querySelector(`[name="drink1"]`).value = drink1;
                orderForm.querySelector(`[name="drink2"]`).value = drink2;
            }
            updateLiveSubtotal();
        }

        function updateLiveSubtotal() {
            let subtotal = 0;
            if (orderForm.dataset.formType === 'single') {
                const main = orderForm.querySelector('[name="mainCourse"]:checked');
                const side = orderForm.querySelector('[name="sideDish"]:checked');
                subtotal = (main ? +main.dataset.price : 0) + (side ? +side.dataset.price : 0);
            } else if (orderForm.dataset.formType === 'double') {
                subtotal = menuData.doubleSet.basePrice;
            }
            document.getElementById('live-subtotal').textContent = `此組合計: NT$ ${formatPrice(subtotal)}`;
        }
        
        function renderSummary() {
            let grandTotal = 0;
            document.getElementById('order-details').innerHTML = allOrders.map(order => {
                grandTotal += order.price;
                const mainCourseItem = order.type === 'single' ? Object.values(menuData.singleSet.options.mainCourse.categories).flatMap(c => c.items).find(i => i.name === order.selections.mainCourse) : null;
                const sideDishItem = order.type === 'single' ? menuData.singleSet.options.sideDish.items.find(i => i.name === order.selections.sideDish) : null;
                
                const summaryItems = order.type === 'single' ? [
                    `<li>開胃小菜</li>`,
                    `<li>前菜: ${order.selections.appetizer}</li>`,
                    `<li>主餐: ${order.selections.mainCourse} <span class="text-xs">NT$ ${formatPrice(mainCourseItem.price)}</span></li>`,
                    `<li>附餐: ${order.selections.sideDish} ${sideDishItem.price > 0 ? `<span class='text-xs'>+NT$ ${formatPrice(sideDishItem.price)}</span>` : ''}</li>`,
                    `<li>土瓶蒸</li>`, `<li>甜點</li>`,
                    `<li>飲料: ${order.selections.drink}</li>`
                ] : [
                    `<li>開胃小菜x2</li>`,
                    `<li>前菜刺身</li>`,
                    `<li>烤一夜干</li>`,
                    `<li>主餐選擇: ${order.selections.mainChoice}</li>`,
                    `<li>總督握壽司</li>`,
                    `<li>烤鰻魚飯x2</li>`,
                    `<li>土瓶蒸x2</li>`,
                    `<li>甜點x2</li>`,
                    `<li>飲料: ${order.selections.drink1}, ${order.selections.drink2}</li>`
                ];

                return `
                    <div class="p-4 border rounded-lg bg-gray-50 relative">
                        <h3 class="font-bold text-lg mb-2">${order.personLabel}: ${order.name}</h3>
                        <ul class="list-disc list-inside text-gray-600 space-y-1">${summaryItems.join('')}</ul>
                        <p class="text-right font-semibold mt-2">小計: NT$ ${formatPrice(order.price)}</p>
                        <button class="btn btn-secondary absolute top-2 right-2 px-3 py-1 text-sm edit-order-btn" data-order-id="${order.id}">修改</button>
                    </div>`;
            }).join('');
            
            const alacarteContainer = document.getElementById('alacarte-section');
            
            const currentAlacarteValues = {};
            alacarteContainer.querySelectorAll('.alacarte-item').forEach(input => {
                if (input.value > 0) {
                    currentAlacarteValues[input.name] = input.value;
                }
            });

            alacarteContainer.innerHTML = Object.entries(menuData.aLaCarte).map(([category, data]) => `
                <div class="mt-4">
                     <img src="${data.image}" alt="${category}" class="alacarte-image">
                    <h3 class="section-title text-base">${category}</h3>
                    ${data.items.map(item => `
                        <div class="flex justify-between items-center bg-gray-100 p-2 rounded mb-2">
                            <span>${item.name} - NT$ ${formatPrice(item.price)}</span>
                            <input type="number" name="${item.name}" min="0" value="${currentAlacarteValues[item.name] || 0}" class="w-20 text-center border rounded alacarte-item" data-price="${item.price}">
                        </div>`).join('')}
                </div>`).join('');
            
            alacarteContainer.querySelectorAll('.alacarte-item').forEach(input => input.addEventListener('change', renderSummary));
            
            let alacarteTotal = Array.from(document.querySelectorAll('.alacarte-item')).reduce((total, input) => total + (input.value * input.dataset.price), 0);
            grandTotal += alacarteTotal;
            const serviceCharge = Math.round(grandTotal * 0.1);

            document.getElementById('order-total').innerHTML = `
                <p class="flex justify-between"><span>餐點總計:</span> <span>NT$ ${formatPrice(grandTotal - alacarteTotal)}</span></p>
                <p class="flex justify-between"><span>單點總計:</span> <span>NT$ ${formatPrice(alacarteTotal)}</span></p>
                <p class="flex justify-between"><span>服務費 (10%):</span> <span>NT$ ${formatPrice(serviceCharge)}</span></p>
                <p class="flex justify-between text-xl text-red-600"><span>最終總計:</span> <span>NT$ ${formatPrice(grandTotal + serviceCharge)}</span></p>`;
            
            document.getElementById('add-more-diners-btn').style.display = dinersOrdered < totalDiners ? 'inline-block' : 'none';
            summaryDinerCountInput.value = totalDiners;
            showView('summary-view');
        }

        function handleOrderSubmission(e) {
            e.preventDefault();
            const selections = getFormData(e.target);
            const formType = e.target.dataset.formType;
            let order;

            if (formType === 'single') {
                const price = +e.target.querySelector('[name="mainCourse"]:checked').dataset.price + +e.target.querySelector('[name="sideDish"]:checked').dataset.price;
                order = { type: 'single', name: menuData.singleSet.name, diners: 1, selections, price };
            } else {
                order = { type: 'double', name: menuData.doubleSet.name, diners: 2, selections, price: menuData.doubleSet.basePrice };
            }

            if (editingOrderId) {
                const index = allOrders.findIndex(o => o.id === editingOrderId);
                dinersOrdered += order.diners - allOrders[index].diners;
                allOrders[index] = { ...allOrders[index], ...order };
                editingOrderId = null;
            } else {
                order.id = Date.now();
                order.personLabel = order.diners > 1 ? `第 ${dinersOrdered + 1} & ${dinersOrdered + 2} 位顧客` : `第 ${dinersOrdered + 1} 位顧客`;
                allOrders.push(order);
                dinersOrdered += order.diners;
            }
            
            if (dinersOrdered >= totalDiners) renderSummary();
            else startNextDiner();
        }

        function startNextDiner() {
            editingOrderId = null;
            document.getElementById('person-title').textContent = `為第 ${dinersOrdered + 1} 位顧客點餐 ( ${dinersOrdered} / ${totalDiners} 位已點)`;
            const doubleSetChoice = document.querySelector('.set-choice-btn[data-set-type="double"]');
            const canSelectDouble = totalDiners - dinersOrdered >= 2;
            doubleSetChoice.style.opacity = canSelectDouble ? '1' : '0.5';
            doubleSetChoice.style.pointerEvents = canSelectDouble ? 'auto' : 'none';
            showView('set-selection-view');
        }

        function editOrder(orderId) {
            editingOrderId = orderId;
            const orderToEdit = allOrders.find(o => o.id === orderId);
            document.getElementById('ordering-person-title').textContent = `修改 ${orderToEdit.personLabel} 的餐點`;
            
            const isDouble = orderToEdit.type === 'double';
            const heroContainer = document.getElementById('ordering-hero-image-container');
            if (isDouble) {
                heroContainer.innerHTML = `
                    <div class="hero-block bg-stone-700">
                        <h2 class="text-3xl font-bold">雙人總督套餐</h2>
                    </div>
                    <img src="https://i.urusai.cc/WifQy.jpg" alt="雙人總督套餐示意圖" class="w-full h-auto">
                `;
            } else {
                heroContainer.innerHTML = `<div class="hero-block bg-amber-800"><h2 class="text-3xl font-bold">單人日式套餐</h2></div>`;
            }

            if (orderToEdit.type === 'single') populateSingleSetForm(orderToEdit);
            else populateDoubleSetForm(orderToEdit);
            showView('ordering-view');
        }

        function restartApp() {
            totalDiners = 2;
            dinersOrdered = 0;
            allOrders = [];
            editingOrderId = null;
            dinerCountInput.value = '2';
            summaryDinerCountInput.value = '2';
            document.getElementById('alacarte-section').innerHTML = '';
            showView('start-view');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('start-order-btn').addEventListener('click', () => {
            totalDiners = +dinerCountInput.value;
            if (totalDiners > 6 || totalDiners < 1) return alert("用餐人數必須介於 1 到 6 位之間。");
            dinersOrdered = 0;
            allOrders = [];
            startNextDiner();
        });
        
        document.getElementById('set-selection-view').addEventListener('click', e => {
            const choice = e.target.closest('.set-choice-btn');
            if (!choice) return;
            const setType = choice.dataset.setType;
            const isDouble = setType === 'double';
            if (isDouble && totalDiners - dinersOrdered < 2) return alert('剩餘用餐人數不足，無法選擇雙人套餐。');
            
            document.getElementById('ordering-person-title').textContent = `為第 ${dinersOrdered + 1} 位顧客點餐`;
            
            const heroContainer = document.getElementById('ordering-hero-image-container');
            if (isDouble) {
                 heroContainer.innerHTML = `
                    <div class="hero-block bg-stone-700">
                        <h2 class="text-3xl font-bold">雙人總督套餐</h2>
                    </div>
                    <img src="https://i.urusai.cc/WifQy.jpg" alt="雙人總督套餐示意圖" class="w-full h-auto">
                `;
            } else {
                heroContainer.innerHTML = `<div class="hero-block bg-amber-800"><h2 class="text-3xl font-bold">單人日式套餐</h2></div>`;
            }
            
            isDouble ? populateDoubleSetForm() : populateSingleSetForm();
            showView('ordering-view');
        });

        document.getElementById('main-content').addEventListener('click', e => {
            if (e.target.closest('.edit-order-btn')) editOrder(+e.target.closest('.edit-order-btn').dataset.orderId);
            if (e.target.closest('.back-to-select')) editingOrderId ? renderSummary() : startNextDiner();
        });
        
        summaryDinerCountInput.addEventListener('change', () => {
            const newTotal = +summaryDinerCountInput.value;
            if (newTotal < dinersOrdered) {
                alert(`無法將人數設為少於已點餐人數(${dinersOrdered})。`);
                summaryDinerCountInput.value = totalDiners;
                return;
            }
            totalDiners = newTotal;
            renderSummary();
        });

        document.getElementById('add-more-diners-btn').addEventListener('click', startNextDiner);
        document.getElementById('back-to-home-btn1').addEventListener('click', () => showView('start-view'));
        orderForm.addEventListener('submit', handleOrderSubmission);

        document.getElementById('submit-final-order-btn').addEventListener('click', () => {
            document.getElementById('final-order-details').innerHTML = document.getElementById('order-details').innerHTML.replace(/<button.*?<\/button>/g, '');
            let alacarteSummary = Array.from(document.querySelectorAll('.alacarte-item')).filter(i => i.value > 0).map(i => `<li>${i.name} x ${i.value}</li>`).join('');
            if(alacarteSummary) {
                 document.getElementById('final-order-details').innerHTML += `<div class="p-4 border rounded-lg bg-gray-50"><h3 class="font-bold text-lg mb-2">單點加購</h3><ul class="list-disc list-inside text-gray-600 space-y-1">${alacarteSummary}</ul></div>`;
            }
            document.getElementById('final-order-total').innerHTML = document.getElementById('order-total').innerHTML;
            
            const now = new Date();
            const pad = (num) => num.toString().padStart(2, '0');
            const orderNumber = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
            document.getElementById('order-number-display').innerHTML = `<p class="text-lg">訂單編號: <strong>${orderNumber}</strong></p>`;

            showView('final-order-view');
        });

        document.getElementById('restart-order-btn').addEventListener('click', restartApp);

        // Initialize the app
        restartApp();
    </script>
</body>
</html>

